<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


      <!-- CSS  -->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
      <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>

<body>
<div id="wrapper">
  <div id="user"></div>


  <div id="recentStuff"></div>

  <div id="activities">
    <table class="striped">
      <thead id="tableHead">
        <tr>
          <th>Segment Name</th>
            <th>Activity Count</th>
          </tr>
        </thead>
        <tbody id="tableRows">
        </tbody>
      </table>
  </div>
  <div>-- FIN --</div>

  <div id="debug">
  </div>
</div>


</body>



<script>

    var allSegments = [];

    $("#wrapper").each(function() {
      callStrava();

      console.log("DONE?");

    });
    function callStrava() {
        var segMap = [];
        var url = "https://www.strava.com/api/v3/athletes/15535211";
        apiCall(url, drawAthlete);

    };

    function apiCall(url, handler) {
      $.ajax({
          method: "GET",
          headers: {
            'Authorization': 'Bearer 28fb470866dbe165f358b66aa1f5198b9059cd0b'
          },
          url: url,
          success: function(data) {
              handler(data);
          }
      });
    };
    function drawAthlete(athlete) {
      document.getElementById("user").innerHTML = athlete.username;
      var url = "https://www.strava.com/api/v3/athlete/activities";
      apiCall(url, drawActivities);

    };

    function drawActivities(activities) {

      var activityCount = activities.length;
      document.getElementById("recentStuff").innerHTML = "Fetched the most recent " +activities.length+ " activities";
      for (var i = 0; i < activities.length; i++) {
        var url = "https://www.strava.com/api/v3/activities/" + activities[i].id;
        apiCall(url, drawActivity);
      }

    };

    function drawActivity(activity) {
      for (var j = 0; j < activity.segment_efforts.length; j++) {
        var segmentEffort = activity.segment_efforts[j];
        var segment =segmentEffort.segment;
        if (allSegments.indexOf(segmentEffort.name) > 0) {
          updateSegment(segment);
        } else {
          allSegments.push(segmentEffort.name);
          buildSegment(segment);
        }
      }
    };

    function buildSegment(segment) {
      var row = document.createElement('tr');
      row.id  = "segment"+segment.id;

      var rowName = document.createElement('td');
      rowName.innerText =  segment.name;
      rowName.id = "segName"+segment.id;

      var rowCount = document.createElement('td');
      rowCount.innerText =  "1";
      rowCount.id = "segCount"+segment.id;

      var row = document.createElement('tr');
      row.appendChild(rowName);
      row.appendChild(rowCount);
      document.getElementById("tableRows").appendChild(row);
    };

    function updateSegment(segment) {
      var oldCount = document.getElementById("segCount"+segment.id).innerText;
      document.getElementById("segCount"+segment.id).innerText = parseInt(oldCount)+1;
    };


</script>

</html>
