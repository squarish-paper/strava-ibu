<!DOCTYPE html>
<html>

<head>

<!-- JS -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!--<script type="text/javascript" src="js/jquery-latest.js"></script>-->
<script type="text/javascript" src="js/jquery.tablesorter.js"></script>

      <!-- CSS  -->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
      <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>

<body>
<div id="wrapper">


  <button id="btnFetch" onclick="fetchStuff()">FETCH</button>
  <div id="user"></div>


  <div id="recentStuff"></div>

  <div id="activities">
    <!--<table  id="tableSegments" class="striped tablesorter">-->
    <table id="tableSegments" class="tablesorter">
      <thead id="tableHead">
        <tr>
          <th>Segment Name</th>
            <th>Activity Count</th>
            <th>Time</th>
            <th>Distance</th>
          </tr>
        </thead>
        <tbody id="tableRows">
          <tr>
            <td>DUMMY</td>
            <td>1</td>
            <td>4</td>
            <td>4</td>
          </tr>
        </tbody>
      </table>
  </div>

  <div id="debug">
  </div>
</div>


</body>



<script>

    var allSegments = [];
    $(document).ready(function()
        {
            $("#tableSegments").tablesorter();
        }
    );

    function fetchStuff() {
      callStrava();
    };

    function callStrava() {
        var segMap = [];
        var url = "https://www.strava.com/api/v3/athletes/15535211";
        apiCall(url, drawAthlete);

    };

    function apiCall(url, handler) {
      $.ajax({
          method: "GET",
          headers: {
            'Authorization': 'Bearer 28fb470866dbe165f358b66aa1f5198b9059cd0b'
          },
          url: url,
          success: function(data) {
              handler(data);
          }
      });
    };
    function drawAthlete(athlete) {
      document.getElementById("user").innerHTML = athlete.username;
      var url = "https://www.strava.com/api/v3/athlete/activities";
      apiCall(url, drawActivities);

    };

    function drawActivities(activities) {

      var activityCount = activities.length;
      document.getElementById("recentStuff").innerHTML = "Fetched the most recent " +activities.length+ " activities";
      for (var i = 0; i < activities.length; i++) {
        var url = "https://www.strava.com/api/v3/activities/" + activities[i].id;
        apiCall(url, drawActivity);
      }

    };

    function drawActivity(activity) {
      for (var j = 0; j < activity.segment_efforts.length; j++) {
        var segmentEffort = activity.segment_efforts[j];
        if (allSegments.indexOf(segmentEffort.segment.id) > 0) {
          updateSegment(segmentEffort);
        } else {
          allSegments.push(segmentEffort.segment.id);
          buildSegment(segmentEffort);
        }
        $("#tableSegments").trigger("update");

      }
    };

    function drawSegment(leaderboard) {
      console.log(leaderboard.entries[1]);
      for (var k = 0; k < leaderboard.length; k++)  {


      }
    };

    function buildSegment(segmentEffort) {

      var row = document.createElement('tr');
      row.id  = "segment"+segmentEffort.segment.id;

      var td= document.createElement('td');
      var a = document.createElement('a');
      a.href = "https://www.strava.com/segments/"+segmentEffort.segment.id;
      a.text = segmentEffort.segment.name;
      td.appendChild(a);
      row.appendChild(td);

      row.appendChild(newTd("1","segCount"+segmentEffort.segment.id));
      row.appendChild(newTd(segmentEffort.elapsed_time, "segTime"+segmentEffort.segment.id));
      row.appendChild(newTd(segmentEffort.segment.distance, null));
      document.getElementById("tableRows").appendChild(row);

      var url = "https://www.strava.com/api/v3/segments/" +segmentEffort.segment.id + "/leaderboard";
      apiCall(url, drawSegment);

    };

    function updateSegment(segmentEffort) {
      var oldCount = document.getElementById("segCount"+segmentEffort.segment.id).innerText;
      document.getElementById("segCount"+segmentEffort.segment.id).innerText = parseInt(oldCount)+1;

      var oldTime = document.getElementById("segTime"+segmentEffort.segment.id).innerText;

      if (oldTime > segmentEffort.elapsed_time) {
    //    console.log("BETTER TIME!" + segmentEffort.segment.name + " " + oldTime + " " + segmentEffort.elapsed_time);
        document.getElementById("segTime"+segmentEffort.segment.id).innerText = parseInt(segmentEffort.elapsed_time);
      }


    };

    function newTd(data,id) {
      var td = document.createElement('td');
      td.innerText =  data;
      if (id != null) {
        td.id = id;
      }
      return td;
    }

</script>

</html>
